---
layout:     post
title:      "SystemUI-字节码插桩"
subtitle:   ""
date:       2022-03-28 12:00:00
author:     "Yaku"
header-img: "img/post-bg-2015.jpg"
tags:
    - Android
    - SystemUI
---



# 1.java_genrule介绍

在阅读系统源码时，发现了一个有意思的工具lockedregioncodeinjection，从命名来看是对锁处理的地方做代码插桩，其使用的代码如下：

```Java
java_genrule {
    name: "services.core.priorityboosted",
    srcs: [":services.core.unboosted"],
    tools: ["lockedregioncodeinjection"],
    cmd: "$(location lockedregioncodeinjection) " +
        "  --targets \"Lcom/android/server/am/ActivityManagerService;,Lcom/android/server/wm/WindowManagerGlobalLock;\" " +
        "  --pre \"com/android/server/am/ActivityManagerService.boostPriorityForLockedSection,com/android/server/wm/WindowManagerService.boostPriorityForLockedSection\" " +
        "  --post \"com/android/server/am/ActivityManagerService.resetPriorityAfterLockedSection,com/android/server/wm/WindowManagerService.resetPriorityAfterLockedSection\" " +
        "  -o $(out) " +
        "  -i $(in)",
    out: ["services.core.priorityboosted.jar"],
}
```

从源码中查找 java_genrule 的定义：

```Plain
// genrule.go

java_genrule is a genrule that can depend on other java_* objects.

By default a java_genrule has a single variant that will run against the device variant of its dependencies and
produce an output that can be used as an input to a device java rule.

Specifying `host_supported: true` will produce two variants, one that uses device dependencies and one that uses
host dependencies.  Each variant will run the command.

Use a java_genrule instead of a genrule when it needs to depend on or be depended on by other java modules, unless
the dependency is for a generated source file.

Examples:

Use a java_genrule to package generated java resources:

    java_genrule {
        name: "generated_resources",
        tools: [
            "generator",
            "soong_zip",
        ],
        srcs: ["generator_inputs/**/*"],
        out: ["generated_android_icu4j_resources.jar"],
        cmd: "$(location generator) $(in) -o $(genDir) " +
            "&& $(location soong_zip) -o $(out) -C $(genDir)/res -D $(genDir)/res",
    }

    java_library {
        name: "lib_with_generated_resources",
        srcs: ["src/**/*.java"],
        static_libs: ["generated_resources"],
    }
```

大意是 java_genrule 是一个依赖其他 java_* 对象的生成规则，比如java_library。这里的cmd参数是要执行的命令，tools是命令中使用的工具，srcs是输入文件，out是输出文件。

接着查找lockedregioncodeinjection工具的位置：

```SQL
java_binary_host {
    name: "lockedregioncodeinjection",
    manifest: "manifest.txt",
    srcs: ["src/**/*.java"],
    static_libs: [
        "asm-9.2",
        "asm-commons-9.2",
        "asm-tree-9.2",
        "asm-analysis-9.2",
        "guava-21.0",
    ],
}
```

可以看到lockedregioncodeinjection是一个可运行的jar包，其入口定义在manifest.txt：

```Plain
Main-Class: lockedregioncodeinjection.Main
```

整个jar包入口在工程的Main类中：

```Java
public static void main(String[] args) throws IOException {
    String inJar = null;
    String outJar = null;

    String legacyTargets = null;
    String legacyPreMethods = null;
    String legacyPostMethods = null;
    for (int i = 0; i < args.length; i++) {
        if ("-i".equals(args[i].trim())) {
            i++;
            inJar = args[i].trim();
        } else if ("-o".equals(args[i].trim())) {
            i++;
            outJar = args[i].trim();
        } else if ("--targets".equals(args[i].trim())) {
            i++;
            legacyTargets = args[i].trim();
        } else if ("--pre".equals(args[i].trim())) {
            i++;
            legacyPreMethods = args[i].trim();
        } else if ("--post".equals(args[i].trim())) {
            i++;
            legacyPostMethods = args[i].trim();
        }

    }

    // TODO(acleung): Better help message than asserts.
    assert inJar != null;
    assert outJar != null;
    assert legacyTargets == null || (legacyPreMethods != null && legacyPostMethods != null);

    ZipFile zipSrc = new ZipFile(inJar);
    ZipOutputStream zos = new ZipOutputStream(new FileOutputStream(outJar));
    List<LockTarget> targets = null;
    if (legacyTargets != null) {
        targets = Utils.getTargetsFromLegacyJackConfig(legacyTargets, legacyPreMethods,
                legacyPostMethods);
    } else {
        targets = Collections.emptyList();
    }

    Enumeration<? extends ZipEntry> srcEntries = zipSrc.entries();
    while (srcEntries.hasMoreElements()) {
        ZipEntry entry = srcEntries.nextElement();
        ZipEntry newEntry = new ZipEntry(entry.getName());
        newEntry.setTime(entry.getTime());
        zos.putNextEntry(newEntry);
        BufferedInputStream bis = new BufferedInputStream(zipSrc.getInputStream(entry));

        if (entry.getName().endsWith(".class")) {
            convert(bis, zos, targets);
        } else {
            while (bis.available() > 0) {
                zos.write(bis.read());
            }
            zos.closeEntry();
            bis.close();
        }
    }
    zos.finish();
    zos.close();
    zipSrc.close();
}
```

核心逻辑为解析命令参数，对代码做插桩。

如何使用生成的 services.core.priorityboosted.jar 呢？可以看到 java_genrule 可以像其他 java_* 对象一样，直接作为编译依赖项。

```Plain
java_library {
    name: "services.core",
    static_libs: ["services.core.priorityboosted"],
}
```

# 2.应用字节码插桩

无论是Gradle编译还是bp编译，其核心流程都是一致的，在编译前都会生成基于拓扑排序的编译依赖关系。基于SystemUI的Android.bp文件，来分析下编译依赖关系：

```Plain
android_app {
    name: "SystemUI",
    defaults: [

    ],
    static_libs: [
        "SystemUI-core",
    ],
    resource_dirs: [],

    platform_apis: true,
    system_ext_specific: true,
    certificate: "platform",
    privileged: true,

    libs: [
        "android.car",
        "ims-common",
        "extphonelib",
    ],
    enforce_uses_libs: false,

    kotlincflags: ["-Xjvm-default=enable"],

    dxflags: ["--multi-dex"],
    required: [
        "privapp_whitelist_com.android.systemui",
    ],
}
```

可以看到编译SystemUI.apk主要依赖SystemUI-core，

```Plain
android_app {
    name: "SystemUI",
    static_libs: [
        "SystemUI-core",
    ],
    resource_dirs: [],

    platform_apis: true,
    product_specific: true,
    certificate: "platform",
    privileged: true,

    optimize: {
        proguard_flags_files: ["proguard.flags"],
    },

    libs: [
        "android.car",
        "android.car.userlib",
        "ims-common",
        "telephony-common",
        "telephony-ext",
        "miuisdk",
    ],

    kotlincflags: ["-Xjvm-default=enable"],

    dxflags: ["--multi-dex"],
    required: ["privapp_whitelist_com.android.systemui"],

}

android_library {
    name: "SystemUI-core",
    srcs: [
        "src/**/*.kt",
        "src/**/*.java",
        "src/**/I*.aidl",
    ],
    resource_dirs: [
        "res-keyguard",
        "res",
    ],
    static_libs: [
        "SystemUIPluginLib",
        "SystemUISharedLib",
        "SettingsLib",
        "androidx.legacy_legacy-support-v4",
        "androidx.recyclerview_recyclerview",
        "androidx.preference_preference",
        "androidx.appcompat_appcompat",
        "androidx.mediarouter_mediarouter",
        "androidx.palette_palette",
        "androidx.legacy_legacy-preference-v14",
        "androidx.leanback_leanback",
        "androidx.slice_slice-core",
        "androidx.slice_slice-view",
        "androidx.slice_slice-builders",
        "androidx.arch.core_core-runtime",
        "androidx.lifecycle_lifecycle-extensions",
        "androidx.dynamicanimation_dynamicanimation",
        "androidx-constraintlayout_constraintlayout",
        "iconloader_base",
        "SystemUI-tags",
        "SystemUI-proto",
        "dagger2-2.19",
        "jsr330"
    ],
    manifest: "AndroidManifest.xml",

    libs: [
        "android.car",
        "android.car.userlib",
        "telephony-common",
        "telephony-ext",
        "ims-common",
        "miuisdk",
    ],

    kotlincflags: ["-Xjvm-default=enable"],

    plugins: ["dagger2-compiler-2.19"],
}
```

而SystemUI-core是一个jar包，可以在这二者之间插入java_genrule实现代码插桩，示例如下：

```Plain
genrule {
    name: "SystemUI-codeinjection",
    srcs: [":SystemUI-core"],
    tools: ["xx"],
    cmd: "xx"
    out: ["SystemUI-core-codeinjection.jar"],
}

android_app {
    name: "SystemUI",
    static_libs: [
        "SystemUI-codeinjection",
    ],
    ...
}
```